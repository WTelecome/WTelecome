<!DOCTYPE html>
<html lang="az">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kredit Hesablama</title>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <meta name="theme-color" content="#000000">
    <link rel="manifest" href="/manifest.json">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Montserrat', sans-serif; margin: 0; padding: 10px; background: #f5f5f5; color: #333; }
        body.dark-mode { background: #1a1a1a; color: #e0e0e0; }
        body.dark-mode .container { background: #2c2c2c; box-shadow: 0 4px 16px rgba(0, 0, 0, 0.5); }
        body.dark-mode select, body.dark-mode input { background: #3c3c3c; color: #e0e0e0; border: 1px solid #555; }
        body.dark-mode button { background: #d32f2f; }
        body.dark-mode button:hover { background: #b71c1c; }
        body.dark-mode .info { color: #bbb; }
        body.dark-mode .payment-plan th, body.dark-mode .payment-plan td { border: 1px solid #555; }
        body.dark-mode .details { color: #e0e0e0; }
        body.dark-mode .card-front, body.dark-mode .card-back { background: linear-gradient(135deg, #d32f2f, #b71c1c); }
        .container { background: #ffffff; padding: 15px; border-radius: 15px; box-shadow: 0 4px 16px rgba(147, 112, 219, 0.15); max-width: 100%; }
        .logo { margin-bottom: 10px; text-align: center; font-size: 24px; font-weight: 700; color: #8a2be2; }
        h2 { font-size: 22px; font-weight: 600; margin-bottom: 15px; text-align: center; color: #8a2be2; }
        h3 { font-size: 18px; margin-bottom: 10px; color: #666; }
        select, input, button { display: block; width: 100%; padding: 10px; margin-bottom: 10px; border-radius: 8px; font-size: 14px; }
        select, input { border: 1px solid #ddd; }
        .invalid-input { border: 2px solid #ff4040; }
        button { background: #8a2be2; color: #fff; border: none; cursor: pointer; transition: background 0.3s; }
        button:hover { background: #6a1bb2; }
        #themeToggle { background: #8a2be2; color: #fff; border: none; padding: 10px; border-radius: 8px; cursor: pointer; margin-bottom: 10px; }
        #themeToggle:hover { background: #6a1bb2; }
        .dual-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .dual-section { flex: 1; min-width: 300px; }
        .info { font-size: 12px; color: #888; margin-bottom: 10px; }
        .credit-card-container { perspective: 1000px; margin-top: 20px; cursor: pointer; }
        .credit-card { width: 100%; height: 200px; position: relative; transform-style: preserve-3d; transition: transform 0.6s; will-change: transform; }
        .credit-card.flipped { transform: rotateY(180deg); }
        .card-front, .card-back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; border-radius: 10px; padding: 15px; color: #fff; }
        .card-front { background: linear-gradient(135deg, #8a2be2, #4b0082); z-index: 2; }
        .card-back { background: linear-gradient(135deg, #6a1bb2, #4b0082); transform: rotateY(180deg); }
        .card-front.birmarket, .card-back.birmarket { background: linear-gradient(135deg, #d32f2f, #b71c1c); }
        .card-front.bank, .card-back.bank { background: linear-gradient(135deg, #4682b4, #1e90ff); }
        .card-bank-name { font-size: 18px; font-weight: 600; margin-bottom: 10px; }
        .card-details { display: flex; flex-direction: column; gap: 8px; }
        .card-details div { font-size: 14px; }
        .payment-plan { margin-top: 10px; }
        .payment-plan table { width: 100%; border-collapse: collapse; font-size: 12px; }
        .payment-plan th, .payment-plan td { padding: 5px; text-align: center; border: 1px solid #ddd; }
        .details { margin-top: 10px; font-size: 12px; color: #fff; }
        .details p { margin: 5px 0; }
        .comparison-panel { margin-top: 20px; display: none; }
        .compare-btn, .dual-compare-btn { margin-top: 10px; }
        @media (max-width: 768px) { 
            .dual-container { flex-direction: column; } 
            .logo { font-size: 20px; }
            .comparison-panel canvas { height: 300px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">WTelecome</div>
        <select id="language" onchange="updateLanguage()">
            <option value="az">Azərbaycan</option>
            <option value="en">English</option>
            <option value="ru">Русский</option>
        </select>
        <button id="themeToggle" aria-label="Rejimi dəyişdir" onclick="toggleTheme()">Tünd Rejim</button>
        <h2 id="title">Kredit Hesablama</h2>

        <div class="dual-container">
            <!-- Birinci Ssenari -->
            <div class="dual-section">
                <h3>Hesabat 1</h3>
                <label for="seller1" id="sellerLabel1">Satıcı seçin:</label>
                <select id="seller1" onchange="updateMonths('1')">
                    <option value="taksit" selected>Taksit Kartları</option>
                    <option value="bank">Bank Daxili</option>
                </select>
                <label for="bank1" id="bankLabel1">Bankı seçin:</label>
                <select id="bank1">
                    <option value="tamkart">TamKart</option>
                    <option value="birkart">Birkart</option>
                    <option value="leo">Leo Bank</option>
                    <option value="bolkart">Bolkart</option>
                </select>
                <label for="amount1" id="amountLabel1">Məhsulun dəyəri (AZN):</label>
                <input type="number" id="amount1" placeholder="100 - 10000 AZN" min="100" max="10000" step="1">
                <label for="initialPayment1" id="initialPaymentLabel1">İlkin ödəniş (AZN):</label>
                <input type="number" id="initialPayment1" placeholder="0 AZN" min="0" step="1">
                <div class="info" id="serviceFeeInfo1">*Qalan məbləğə xidmət haqqı əlavə olunur</div>
                <label for="months1" id="monthsLabel1">Neçə ay:</label>
                <select id="months1">
                    <option value="3">3 ay</option>
                    <option value="6">6 ay</option>
                    <option value="9">9 ay</option>
                    <option value="12">12 ay</option>
                    <option value="18">18 ay</option>
                    <option value="24">24 ay</option>
                </select>
                <button id="calculateBtn1" class="calculate-btn" aria-label="Hesabla" onclick="calculatePayment('1')">Hesabla</button>
                <button id="toggleScenarioBtn" class="dual-compare-btn" aria-label="İkinci ssenari" onclick="toggleSecondScenario()">İkinci Ssenarini Aktivləşdir</button>
                <div class="credit-card-container" id="creditCardContainer1" onclick="flipCard('1')">
                    <div class="credit-card" id="creditCard1">
                        <div class="card-front">
                            <div class="card-bank-name" id="cardBankName1">Bank</div>
                            <div class="card-details">
                                <div>Aylıq ödəniş: <span id="cardMonthly1">0.00 AZN</span></div>
                                <div>Faiz dərəcəsi: <span id="cardInterest1">0.00%</span></div>
                                <div>Ümumi məbləğ: <span id="cardTotal1">0.00 AZN</span></div>
                            </div>
                        </div>
                        <div class="card-back">
                            <div class="payment-plan" id="paymentPlanContent1"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- İkinci Ssenari -->
            <div class="dual-section" id="secondScenario" style="display: none;">
                <h3>Hesabat 2</h3>
                <label for="seller2" id="sellerLabel2">Satıcı seçin:</label>
                <select id="seller2" onchange="updateMonths('2')">
                    <option value="taksit" selected>Taksit Kartları</option>
                    <option value="bank">Bank Daxili</option>
                </select>
                <label for="bank2" id="bankLabel2">Bankı seçin:</label>
                <select id="bank2">
                    <option value="tamkart">TamKart</option>
                    <option value="birkart">Birkart</option>
                    <option value="leo">Leo Bank</option>
                    <option value="bolkart">Bolkart</option>
                </select>
                <label for="amount2" id="amountLabel2">Məhsulun dəyəri (AZN):</label>
                <input type="number" id="amount2" placeholder="100 - 10000 AZN" min="100" max="10000" step="1">
                <label for="initialPayment2" id="initialPaymentLabel2">İlkin ödəniş (AZN):</label>
                <input type="number" id="initialPayment2" placeholder="0 AZN" min="0" step="1">
                <div class="info" id="serviceFeeInfo2">*Qalan məbləğə xidmət haqqı əlavə olunur</div>
                <label for="months2" id="monthsLabel2">Neçə ay:</label>
                <select id="months2">
                    <option value="3">3 ay</option>
                    <option value="6">6 ay</option>
                    <option value="9">9 ay</option>
                    <option value="12">12 ay</option>
                    <option value="18">18 ay</option>
                    <option value="24">24 ay</option>
                </select>
                <button id="calculateBtn2" class="calculate-btn" aria-label="Hesabla" onclick="calculatePayment('2')">Hesabla</button>
                <div class="credit-card-container" id="creditCardContainer2" onclick="flipCard('2')">
                    <div class="credit-card" id="creditCard2">
                        <div class="card-front">
                            <div class="card-bank-name" id="cardBankName2">Bank</div>
                            <div class="card-details">
                                <div>Aylıq ödəniş: <span id="cardMonthly2">0.00 AZN</span></div>
                                <div>Faiz dərəcəsi: <span id="cardInterest2">0.00%</span></div>
                                <div>Ümumi məbləğ: <span id="cardTotal2">0.00 AZN</span></div>
                            </div>
                        </div>
                        <div class="card-back">
                            <div class="payment-plan" id="paymentPlanContent2"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <button class="compare-btn" id="compareBtn" aria-label="Bütün bankları müqayisə et" onclick="compareBanks()">Bütün bankları müqayisə et</button>
        <button class="dual-compare-btn" aria-label="İkiqat müqayisə" onclick="dualCompare()">İkiqat Müqayisə</button>
        <div class="comparison-panel" id="comparisonPanel">
            <canvas id="comparisonChart"></canvas>
        </div>
    </div>

    <script>
        const swCode = `
            self.addEventListener('install', (event) => {
                event.waitUntil(
                    caches.open('wtelecome-cache-v1').then(cache => {
                        return cache.addAll([
                            '/index.html',
                            '/manifest.json',
                            'https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700&display=swap',
                            'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css'
                        ]);
                    })
                );
            });

            self.addEventListener('fetch', (event) => {
                event.respondWith(
                    caches.match(event.request).then(response => {
                        return response || fetch(event.request).catch(() => {
                            return caches.match('/offline.html');
                        });
                    })
                );
            });
        `;

        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                const blob = new Blob([swCode], { type: 'application/javascript' });
                const swUrl = URL.createObjectURL(blob);
                navigator.serviceWorker.register(swUrl)
                    .then(reg => {
                        console.log('Service Worker qeydiyyatdan keçdi', reg);
                        URL.revokeObjectURL(swUrl);
                    })
                    .catch(err => console.error('Service Worker qeydiyyatı uğursuz oldu:', err));
            });
        }

        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            const addBtn = document.createElement('button');
            addBtn.textContent = 'Ana Ekrana Əlavə Et';
            addBtn.className = 'compare-btn';
            addBtn.style.marginTop = '20px';
            addBtn.setAttribute('aria-label', 'Tətbiqi ana ekrana əlavə et');
            document.querySelector('.container').appendChild(addBtn);
            addBtn.addEventListener('click', () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('İstifadəçi tətbiqi əlavə etdi');
                    }
                    deferredPrompt = null;
                    addBtn.style.display = 'none';
                });
            });
        });

        const translations = {
            az: {
                title: "Kredit Hesablama",
                sellerLabel: "Satıcı seçin:",
                bankLabel: "Bankı seçin:",
                amountLabel: "Məhsulun dəyəri (AZN):",
                initialPaymentLabel: "İlkin ödəniş (AZN):",
                serviceFeeInfo: "*Qalan məbləğə xidmət haqqı əlavə olunur",
                monthsLabel: "Neçə ay:",
                calculateBtn: "Hesabla",
                compareBtn: "Bütün bankları müqayisə et",
                dualCompareBtn: "İkinci Ssenarini Bağla",
                toggleScenarioBtn: "İkinci Ssenarini Aktivləşdir",
                paymentPlanHeaders: ["Tam ödəniş", "Ödəniş", "Qalıq"],
                comparisonHeaders: ["Bank", "Aylıq Ödəniş", "Ümumi Məbləğ"],
                error: "Məbləğ 100-10000 AZN olmalıdır!",
                initialPaymentError: "İlkin ödəniş məbləğdən çox ola bilməz!",
                emptyInputError: "Bütün sahələri doldurun!",
                interestRateLabel: "Faiz dərəcəsi",
                umumiInfo: "*Ümumi Bank tam ödəniş tələb edir"
            },
            en: {
                title: "Loan Calculator",
                sellerLabel: "Select Seller:",
                bankLabel: "Select Bank:",
                amountLabel: "Product Value (AZN):",
                initialPaymentLabel: "Initial Payment (AZN):",
                serviceFeeInfo: "*A service fee is added to the remaining amount",
                monthsLabel: "Term (months):",
                calculateBtn: "Calculate",
                compareBtn: "Compare All Banks",
                dualCompareBtn: "Close Second Scenario",
                toggleScenarioBtn: "Activate Second Scenario",
                paymentPlanHeaders: ["Full Payment", "Payment", "Remaining"],
                comparisonHeaders: ["Bank", "Monthly Payment", "Total Amount"],
                error: "Amount must be between 100-10000 AZN!",
                initialPaymentError: "Initial payment cannot exceed the amount!",
                emptyInputError: "Please fill all fields!",
                interestRateLabel: "Interest Rate",
                umumiInfo: "*Ümumi Bank requires full payment"
            },
            ru: {
                title: "Калькулятор кредита",
                sellerLabel: "Выберите продавца:",
                bankLabel: "Выберите банк:",
                amountLabel: "Стоимость товара (AZN):",
                initialPaymentLabel: "Первоначальный взнос (AZN):",
                serviceFeeInfo: "*К оставшейся сумме добавляется комиссия",
                monthsLabel: "Срок (месяцев):",
                calculateBtn: "Рассчитать",
                compareBtn: "Сравнить все банки",
                dualCompareBtn: "Закрыть второй сценарий",
                toggleScenarioBtn: "Активировать второй сценарий",
                paymentPlanHeaders: ["Полная оплата", "Платеж", "Остаток"],
                comparisonHeaders: ["Банк", "Ежемесячный платеж", "Общая сумма"],
                error: "Сумма должна быть от 100 до 10000 AZN!",
                initialPaymentError: "Первоначальный взнос не может превышать сумму!",
                emptyInputError: "Заполните все поля!",
                interestRateLabel: "Процентная ставка",
                umumiInfo: "*Ümumi Bank требует полной оплаты"
            }
        };

        const bankNames = {
            "tamkart": "TamKart",
            "birkart": "Birkart",
            "leo": "Leo Bank",
            "bolkart": "Bolkart",
            "resmi": "Rəsmi",
            "qeyri-resmi": "Qeyri-rəsmi"
        };

        let comparisonChart;

        function updateSectionLabels(section, lang) {
            const labels = [
                { id: `sellerLabel${section}`, text: translations[lang].sellerLabel },
                { id: `bankLabel${section}`, text: translations[lang].bankLabel },
                { id: `amountLabel${section}`, text: translations[lang].amountLabel },
                { id: `initialPaymentLabel${section}`, text: translations[lang].initialPaymentLabel },
                { id: `serviceFeeInfo${section}`, text: translations[lang].serviceFeeInfo },
                { id: `monthsLabel${section}`, text: translations[lang].monthsLabel },
                { id: `calculateBtn${section}`, text: translations[lang].calculateBtn }
            ];
            labels.forEach(({ id, text }) => {
                document.getElementById(id).innerText = text;
            });
        }

        function updateLanguage() {
            const lang = document.getElementById("language").value;
            localStorage.setItem('language', lang);
            document.getElementById("title").innerText = translations[lang].title;
            updateSectionLabels('1', lang);
            if (document.getElementById("secondScenario").style.display !== "none") {
                updateSectionLabels('2', lang);
            }
            document.getElementById("compareBtn").innerText = translations[lang].compareBtn;
            document.getElementById("toggleScenarioBtn").innerText = document.getElementById("secondScenario").style.display === "none" ?
                translations[lang].toggleScenarioBtn : translations[lang].dualCompareBtn;
            document.getElementById("themeToggle").innerText = document.body.classList.contains('dark-mode') ?
                (lang === 'az' ? 'Açıq Rejim' : lang === 'en' ? 'Light Mode' : 'Светлый режим') :
                (lang === 'az' ? 'Tünd Rejim' : lang === 'en' ? 'Dark Mode' : 'Темный режим');
            updateMonths('1');
            if (document.getElementById("secondScenario").style.display !== "none") {
                updateMonths('2');
            }
        }

        function toggleTheme() {
            const body = document.body;
            body.classList.toggle('dark-mode');
            const lang = document.getElementById('language').value;
            document.getElementById('themeToggle').innerText = body.classList.contains('dark-mode') ?
                (lang === 'az' ? 'Açıq Rejim' : lang === 'en' ? 'Light Mode' : 'Светлый режим') :
                (lang === 'az' ? 'Tünd Rejim' : lang === 'en' ? 'Dark Mode' : 'Темный режим');
            if (document.getElementById("comparisonPanel").style.display === "block") {
                compareBanks();
            }
        }

        function updateMonths(section) {
            const bankSelect = document.getElementById(`bank${section}`);
            const seller = document.getElementById(`seller${section}`).value;
            const monthsSelect = document.getElementById(`months${section}`);
            const lang = document.getElementById("language").value;
            const currentBank = bankSelect.value || "tamkart";

            monthsSelect.innerHTML = "";
            bankSelect.innerHTML = "";
            const fragment = document.createDocumentFragment();

            if (seller === "bank") {
                const bankOptions = [
                    { value: "resmi", text: translations[lang].bankLabel.split(":")[0] + " (Rəsmi)" },
                    { value: "qeyri-resmi", text: translations[lang].bankLabel.split(":")[0] + " (Qeyri-rəsmi)" }
                ];
                bankOptions.forEach(option => {
                    const opt = document.createElement("option");
                    opt.value = option.value;
                    opt.text = option.text;
                    if (option.value === currentBank) opt.selected = true;
                    fragment.appendChild(opt);
                });
                bankSelect.appendChild(fragment);

                const monthOptions = [
                    { value: "2", text: "2" },
                    { value: "3", text: "3" },
                    { value: "6", text: "6" },
                    { value: "12", text: "12" },
                    { value: "18", text: "18" },
                    { value: "24", text: "24" },
                    { value: "35", text: "35" }
                ];
                monthOptions.forEach(option => {
                    const opt = document.createElement("option");
                    opt.value = option.value;
                    opt.text = option.text + " " + translations[lang].monthsLabel.split(" ")[1];
                    monthsSelect.appendChild(opt);
                });
            } else {
                const bankOptions = [
                    { value: "tamkart", text: "TamKart" },
                    { value: "birkart", text: "Birkart" },
                    { value: "leo", text: "Leo Bank" },
                    { value: "bolkart", text: "Bolkart" }
                ];
                bankOptions.forEach(option => {
                    const opt = document.createElement("option");
                    opt.value = option.value;
                    opt.text = option.text;
                    if (option.value === currentBank) opt.selected = true;
                    fragment.appendChild(opt);
                });
                bankSelect.appendChild(fragment);

                const monthOptions = [
                    { value: "3", text: "3" },
                    { value: "6", text: "6" },
                    { value: "9", text: "9" },
                    { value: "12", text: "12" },
                    { value: "18", text: "18" },
                    { value: "24", text: "24" }
                ];
                monthOptions.forEach(option => {
                    const opt = document.createElement("option");
                    opt.value = option.value;
                    opt.text = option.text + " " + translations[lang].monthsLabel.split(" ")[1];
                    if (bankSelect.value === "birkart" && option.value === "12") return; // Birkart üçün 12 ay yoxdur
                    monthsSelect.appendChild(opt);
                });
            }

            const newBankSelect = bankSelect.cloneNode(true);
            bankSelect.parentNode.replaceChild(newBankSelect, bankSelect);
            newBankSelect.addEventListener('change', () => {
                const lang = document.getElementById("language").value;
                monthsSelect.innerHTML = "";
                const monthOptions = [
                    { value: "3", text: "3" },
                    { value: "6", text: "6" },
                    { value: "9", text: "9" },
                    { value: "12", text: "12" },
                    { value: "18", text: "18" },
                    { value: "24", text: "24" }
                ];
                monthOptions.forEach(option => {
                    const opt = document.createElement("option");
                    opt.value = option.value;
                    opt.text = option.text + " " + translations[lang].monthsLabel.split(" ")[1];
                    if (newBankSelect.value === "birkart" && option.value === "12") return; // Birkart üçün 12 ay yoxdur
                    monthsSelect.appendChild(opt);
                });
                updateSectionLabels(section, lang);
                calculatePayment(section);
            });

            updateSectionLabels(section, lang);
            calculatePayment(section);
        }

        function getInterestRate(bank, months, seller) {
            const taksitRates = {
                "tamkart": { "3": 0.06, "6": 0.10, "9": 0.11, "12": 0.14, "18": 0.16, "24": 0.20 },
                "birkart": { "3": 0.06, "6": 0.10, "9": 0.11, "18": 0.16, "24": 0.21 },
                "leo": { "3": 0.09, "6": 0.13, "9": 0.14, "12": 0.17, "18": 0.20, "24": 0.24 },
                "bolkart": { "3": 0.09, "6": 0.13, "9": 0.14, "12": 0.17, "18": 0.20, "24": 0.24 }
            };

            const bankRates = {
                "resmi": { "2": 0.031, "3": 0.042, "6": 0.074, "12": 0.128, "18": 0.188, "24": 0.247, "35": 0.31 },
                "qeyri-resmi": { "2": 0.036, "3": 0.048, "6": 0.082, "12": 0.147, "18": 0.206, "24": 0.26, "35": 0.354 }
            };

            let rate;
            if (seller === "bank") {
                rate = bankRates[bank]?.[months] || 0;
            } else {
                rate = taksitRates[bank]?.[months] || 0;
            }
            return rate || 0;
        }

        function calculatePayment(section) {
            const lang = document.getElementById("language").value;
            const elements = {
                bank: document.getElementById(`bank${section}`),
                seller: document.getElementById(`seller${section}`),
                amount: document.getElementById(`amount${section}`),
                initialPayment: document.getElementById(`initialPayment${section}`),
                months: document.getElementById(`months${section}`),
                cardMonthly: document.getElementById(`cardMonthly${section}`),
                cardInterest: document.getElementById(`cardInterest${section}`),
                cardTotal: document.getElementById(`cardTotal${section}`),
                cardBankName: document.getElementById(`cardBankName${section}`),
                paymentPlanContent: document.getElementById(`paymentPlanContent${section}`),
                cardFront: document.getElementById(`creditCard${section}`).querySelector('.card-front'),
                cardBack: document.getElementById(`creditCard${section}`).querySelector('.card-back')
            };

            elements.amount.classList.remove('invalid-input');
            elements.initialPayment.classList.remove('invalid-input');

            elements.cardFront.classList.remove('birmarket', 'bank');
            elements.cardBack.classList.remove('birmarket', 'bank');
            if (elements.seller.value === "taksit") {
                elements.cardFront.classList.add('birmarket');
                elements.cardBack.classList.add('birmarket');
            } else if (elements.seller.value === "bank") {
                elements.cardFront.classList.add('bank');
                elements.cardBack.classList.add('bank');
            }

            const amount = parseFloat(elements.amount.value) || 0;
            const initialPayment = parseFloat(elements.initialPayment.value) || 0;
            const monthsValue = elements.months.value;
            const months = parseInt(monthsValue);

            if (isNaN(amount) || isNaN(initialPayment) || amount < 100 || amount > 10000 || initialPayment > amount) {
                elements.amount.classList.add('invalid-input');
                elements.initialPayment.classList.add('invalid-input');
                elements.cardMonthly.innerText = translations[lang].error;
                elements.cardInterest.innerText = translations[lang].error;
                elements.cardTotal.innerText = !elements.amount.value || !elements.initialPayment.value ? translations[lang].emptyInputError :
                                             initialPayment > amount ? translations[lang].initialPaymentError : translations[lang].error;
                elements.cardMonthly.style.color = "#ff4040";
                elements.cardInterest.style.color = "#ff4040";
                elements.cardTotal.style.color = "#ff4040";
                elements.paymentPlanContent.innerHTML = "";
                return;
            }

            const remainingAmount = amount - initialPayment;
            const serviceFee = elements.seller.value === "taksit" ? 20 : 0;
            const amountWithFee = remainingAmount + serviceFee;
            const interestRate = getInterestRate(elements.bank.value, monthsValue, elements.seller.value);
            const totalInterest = amountWithFee * interestRate;
            let totalAmount = amountWithFee + totalInterest;

            elements.cardBankName.innerText = bankNames[elements.bank.value];
            elements.cardMonthly.style.color = "#ffffff";
            elements.cardInterest.style.color = "#ffffff";
            elements.cardTotal.style.color = "#ffffff";

            totalAmount = Math.round(totalAmount / 10) * 10;
            const monthlyPayment = totalAmount / months;
            elements.cardMonthly.innerText = monthlyPayment.toFixed(2) + " AZN";
            elements.cardInterest.innerText = (interestRate * 100).toFixed(2) + "%";
            elements.cardTotal.innerText = totalAmount.toFixed(2) + " AZN";

            let remainingDebt = totalAmount;
            let tableHTML = `<table><tr><th>${translations[lang].paymentPlanHeaders[0]}</th><th>${translations[lang].paymentPlanHeaders[1]}</th><th>${translations[lang].paymentPlanHeaders[2]}</th></tr>`;
            for (let i = 1; i <= months; i++) {
                remainingDebt -= monthlyPayment;
                tableHTML += `<tr><td>${i}</td><td>${monthlyPayment.toFixed(2)} AZN</td><td>${Math.max(0, remainingDebt).toFixed(2)} AZN</td></tr>`;
            }
            tableHTML += `</table>
                <div class="details">
                    <p>${translations[lang].amountLabel} ${amount.toFixed(2)} AZN</p>
                    <p>${translations[lang].serviceFeeInfo.replace('*', '')}: ${serviceFee.toFixed(2)} AZN</p>
                    <p>${translations[lang].interestRateLabel}: ${(interestRate * 100).toFixed(2)}%</p>
                </div>`;
            elements.paymentPlanContent.innerHTML = tableHTML;
        }

        function toggleSecondScenario() {
            const secondScenario = document.getElementById("secondScenario");
            const button = document.getElementById("toggleScenarioBtn");
            const lang = document.getElementById("language").value;
            if (secondScenario.style.display === "none") {
                secondScenario.style.display = "block";
                button.innerText = translations[lang].dualCompareBtn;
                updateMonths('2');
            } else {
                secondScenario.style.display = "none";
                button.innerText = translations[lang].toggleScenarioBtn;
            }
        }

        function flipCard(section) {
            document.getElementById(`creditCard${section}`).classList.toggle('flipped');
        }

        function compareBanks() {
            const seller = document.getElementById("seller1").value;
            const amountInput = document.getElementById("amount1").value;
            const initialPaymentInput = document.getElementById("initialPayment1").value;
            const amount = parseFloat(amountInput) || 0;
            const initialPayment = parseFloat(initialPaymentInput) || 0;
            const monthsValue = document.getElementById("months1").value;
            const months = parseInt(monthsValue);
            const lang = document.getElementById("language").value;

            if (isNaN(amount) || isNaN(initialPayment) || amount < 100 || amount > 10000 || initialPayment > amount) {
                alert(!amountInput || !initialPaymentInput ? translations[lang].emptyInputError :
                      initialPayment > amount ? translations[lang].initialPaymentError : translations[lang].error);
                document.getElementById("amount1").classList.add('invalid-input');
                document.getElementById("initialPayment1").classList.add('invalid-input');
                return;
            }

            const remainingAmount = amount - initialPayment;
            const serviceFee = seller === "taksit" ? 20 : 0;
            const amountWithFee = remainingAmount + serviceFee;

            const banks = seller === "bank" ? ["resmi", "qeyri-resmi"] : ["tamkart", "birkart", "leo", "bolkart"];
            const monthlyPayments = [];
            const totalAmounts = [];

            banks.forEach(bank => {
                const interestRate = getInterestRate(bank, monthsValue, seller);
                const totalInterest = amountWithFee * interestRate;
                let totalAmount = amountWithFee + totalInterest;
                totalAmount = Math.round(totalAmount / 10) * 10;
                const monthlyPayment = totalAmount / months;
                monthlyPayments.push(monthlyPayment.toFixed(2));
                totalAmounts.push(totalAmount.toFixed(2));
            });

            const ctx = document.getElementById("comparisonChart").getContext("2d");
            if (comparisonChart) comparisonChart.destroy();

            const isDarkMode = document.body.classList.contains('dark-mode');
            comparisonChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: banks.map(bank => bankNames[bank]),
                    datasets: [
                        {
                            label: translations[lang].comparisonHeaders[1],
                            data: monthlyPayments,
                            backgroundColor: banks.map((_, i) => isDarkMode ? `hsl(${i * 60}, 70%, 60%)` : `hsl(${i * 60}, 70%, 50%)`),
                            borderColor: banks.map((_, i) => isDarkMode ? `hsl(${i * 60}, 70%, 50%)` : `hsl(${i * 60}, 70%, 40%)`),
                            borderWidth: 1
                        },
                        {
                            label: translations[lang].comparisonHeaders[2],
                            data: totalAmounts,
                            backgroundColor: banks.map((_, i) => isDarkMode ? `hsl(${i * 60 + 30}, 70%, 60%)` : `hsl(${i * 60 + 30}, 70%, 50%)`),
                            borderColor: banks.map((_, i) => isDarkMode ? `hsl(${i * 60 + 30}, 70%, 50%)` : `hsl(${i * 60 + 30}, 70%, 40%)`),
                            borderWidth: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: isDarkMode ? '#e0e0e0' : '#333' },
                            grid: { color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }
                        },
                        x: {
                            ticks: { color: isDarkMode ? '#e0e0e0' : '#333' },
                            grid: { color: isDarkMode ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)' }
                        }
                    },
                    plugins: {
                        legend: { labels: { color: isDarkMode ? '#e0e0e0' : '#333' } },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    const bank = banks[context.dataIndex];
                                    const rate = getInterestRate(bank, monthsValue, seller);
                                    return `${context.dataset.label}: ${context.raw} AZN (Faiz: ${(rate * 100).toFixed(2)}%)`;
                                }
                            }
                        }
                    }
                }
            });

            document.getElementById("comparisonPanel").style.display = "block";
        }

        function dualCompare() {
            calculatePayment('1');
            calculatePayment('2');
            if (document.getElementById("secondScenario").style.display === "none") toggleSecondScenario();
        }

        window.addEventListener('load', () => {
            const savedLang = localStorage.getItem('language') || 'az';
            document.getElementById('language').value = savedLang;
            updateMonths('1');
            updateMonths('2');
            updateLanguage();

            ['amount1', 'initialPayment1', 'bank1', 'seller1', 'months1'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => calculatePayment('1'));
            });
            ['amount2', 'initialPayment2', 'bank2', 'seller2', 'months2'].forEach(id => {
                document.getElementById(id).addEventListener('input', () => calculatePayment('2'));
            });
        });
    </script>
</body>
</html>
